{% extends "csss/new_header.html" %}
{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages %}
{% load get_position_names %}
{% block content %}
	<h1 class="title">Modify Election</h1>
    {%  include 'elections/json/creating_election_errors.html' %}
	<form method="post" class="form">
		{% csrf_token %}
        <p>Date For Election to be publicly available: <input type="date" name="{{date_key}}" value="{{date}}" required> <p>
        <p>Time for Election to be publicly available: (press "a" or "p" for the last field)<br>
            <input type="time" name="{{time_key}}" value="{{time}}" required>
        </p>
        <p>Valid Positions:
            {% for position in positions %}
                {{ position.position_name }},
            {% endfor %}
        </p>
        <p>Election Type :
            <select name="{{election_type_key}}">
                {%  for election_type in election_types %}
                    {%  if selected_election_type == election_type.0 %}
                        <option  selected="selected" value="{{election_type.0}}">{{election_type.1}}</option>
                    {%  else %}
                        <option value="{{election_type.0}}">{{election_type.1}}</option>
                    {%  endif %}
                {%  endfor %}
            </select>
        <p>
        <p><b>For Any Links Below, leave as NONE if none to give. If however, you do have the link, remeber to prefix it with "http://"</b></p>
        <a href=\"https://wordtohtml.net/\" target=\"_blank\"> Useful Speech Formatter</a>
        <p>Websurvey Link : <input type="text" name="{{websurvey_link_key}}" value="{{websurvey}}" required></p>
        <input type="submit" value="submit" />
        <br><br><br>
        <input type="button" value="Add another Nominee" onClick="addBlankNominee('{{nominee_key}}');">
        <input type="text" name="{{election_id_key}}" value="{{election_id}}" hidden readonly>
        <div id="{{nominee_key}}"></div>
        <br>
    </form>

    <script type="text/javascript">
		function removeDiv(divName){$(divName).remove();}

        (function () {
            let nominee_index;
            let new_nominee;
            let nominee_speeches;
            let speech_index;
            let new_nominee_speech;
            let nominee_position;
            let speech_div_name;
            let nominee_div_name;
            let speech_parent_div_name;
            let nominees_div_name = '{{nominee_key}}';
            {%  if nominees is None %}
                addBlankNominee(nominees_div_name)
            {%  else %}
                {%  for nominee in nominees %}
                    nominee_index = document.getElementById(nominees_div_name).childElementCount;
                    nominee_div_name = 'nominee_' + nominee_index;
                    speech_parent_div_name = nominee_div_name + '_speeches';


                    new_nominee = document.createElement('div');
                    new_nominee.setAttribute('id',nominee_div_name);
                    new_nominee.setAttribute('style', 'border: 3px solid black; padding: 10px;');
                    new_nominee.innerHTML += "<input type=\"button\" value=\"Remove Nominee\" onClick=\"removeDiv('#"+nominee_div_name+"');\">";
                    new_nominee.innerHTML += "<input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{nominee_id_key}}]\" value=\"{{nominee.id}}\" hidden readonly>";
                    new_nominee.innerHTML += "<p>Full Name: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{name_key}}]\" value=\"{{nominee.name}}\" required></p>";
                    new_nominee.innerHTML += "<p>Facebook Link: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{facebook_key}}]\" value=\"{{nominee.facebook}}\" required></p>";
                    new_nominee.innerHTML += "<p>LinkedIn Link: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{linkedin_key}}]\" value=\"{{nominee.linked_in}}\" required></p>";
                    new_nominee.innerHTML += "<p>Email Address: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{email_key}}]\" value=\"{{nominee.email}}\" required></p>";
                    new_nominee.innerHTML += "<p>Discord Username: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{discord_key}}]\" value=\"{{nominee.discord}}\" required></p>";
                    new_nominee.innerHTML += "<input type=\"button\" value=\"Add Another Speech\" onClick=\"addBlankSpeech('"+nominee_index+"');\">";

                    document.getElementById(nominees_div_name).appendChild(new_nominee);
                    nominee_speeches = document.createElement('div');
                    nominee_speeches.setAttribute('id',speech_parent_div_name);
                    new_nominee.appendChild(nominee_speeches);

                    {%  for position_names_and_speech_pairing in nominee.position_names_and_speech_pairings %}
                        speech_index = nominee_speeches.childElementCount;
                        speech_div_name = nominee_div_name + '_speech_' + speech_index;

                        new_nominee_speech = document.createElement('div');
                        new_nominee_speech.setAttribute('id',speech_div_name);
                        new_nominee_speech.innerHTML += "<p>Positions:</p>";

                        {%  for position in positions %}
                            nominee_position = document.createElement('div');
                            nominee_position.setAttribute('style','display:inline-block');
                            {% get_position_names position_names_and_speech_pairing.position_names as selected_position_names %}
                            {% if position.position_name in selected_position_names %}
                                {% get_position_id position.position_name position_names_and_speech_pairing.position_names as position_id %}
                                nominee_position.innerHTML += "<input name=\"[{{nominee_key}}]["+nominee_index+"]" +
                                    "[{{speech_and_position_pairing_key}}]["+speech_index+"][{{position_names_key}}]\"  "+
                                    "type=\"checkbox\" id=\"{{ position.position_name }}_{{ position_id }}\" value=\"{{ position.position_name }}_{{ position_id }}\" checked />";
                                {%  clear_variable as position_id %}
                            {%  else %}
                                nominee_position.innerHTML += "<input name=\"[{{nominee_key}}]["+nominee_index+"]" +
                                    "[{{speech_and_position_pairing_key}}]["+speech_index+"][{{position_names_key}}]\"  "+
                                    "type=\"checkbox\" id=\"{{ position.position_name }}\" value=\"{{ position.position_name }}\"  />";
                            {%  endif %}
                            nominee_position.innerHTML += "<label>{{ position.position_name }}</label><br>";
                            new_nominee_speech.appendChild(nominee_position);
                        {%  endfor %}

                        new_nominee_speech.innerHTML += "<p>Speech: (speech needs to already be in HTML format)<br>" +
                            "<textarea name=\"[{{nominee_key}}]["+nominee_index+"][{{speech_and_position_pairing_key}}]"+
                            "["+speech_index+"][{{speech_key}}]\" cols=\"40\" rows=\"1\" required>{{position_names_and_speech_pairing.speech}}</textarea></p>"
                        new_nominee_speech.innerHTML += "<input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{speech_and_position_pairing_key}}]["+speech_index+"][{{speech_id}}]\" value=\"{{position_names_and_speech_pairing.id}}\" hidden readonly>"
                        new_nominee_speech.innerHTML += "<input type=\"button\" value=\"Remove Speech\" onClick=\"removeDiv('#"+speech_div_name+"');\">";
                        nominee_speeches.appendChild(new_nominee_speech);
                    {%  endfor %}
                {%  endfor %}
            {%  endif %}
        })();

		function addBlankNominee(nominees_div_name){
		    let nominee_index;
		    if (document.getElementById(nominees_div_name).lastChild === null){
		        nominee_index = document.getElementById(nominees_div_name).childElementCount;
            }else{
		        nominee_index = parseInt(document.getElementById(nominees_div_name).lastChild.id.replace('nominee_',"")) + 1
            }
            const nominee_div_name = 'nominee_' + nominee_index;
            const nominee_speech_div_name = nominee_div_name + '_speeches';

            let new_nominee = document.createElement('div');
            new_nominee.setAttribute('id',nominee_div_name);
            new_nominee.setAttribute('style', 'border: 3px solid black; padding: 10px;');
            new_nominee.innerHTML += "<input type=\"button\" value=\"Remove Nominee\" onClick=\"removeDiv('#"+nominee_div_name+"');\">";
            new_nominee.innerHTML += "<p>Full Name: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{name_key}}]\" required></p>";
            new_nominee.innerHTML += "<p>Facebook Link: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{facebook_key}}]\" value=\"NONE\" required></p>";
            new_nominee.innerHTML += "<p>LinkedIn Link: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{linkedin_key}}]\" value=\"NONE\" required></p>";
            new_nominee.innerHTML += "<p>Email Address: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{email_key}}]\" value=\"NONE\" required></p>";
            new_nominee.innerHTML += "<p>Discord Username: <input type=\"text\" name=\"[{{nominee_key}}]["+nominee_index+"][{{discord_key}}]\" value=\"NONE\" required></p>";
            new_nominee.innerHTML += "<input type=\"button\" value=\"Add Another Speech\" onClick=\"addBlankSpeech('"+nominee_index+"');\">";

            document.getElementById(nominees_div_name).appendChild(new_nominee);
            let nominee_speeches = document.createElement('div');
            nominee_speeches.setAttribute('id',nominee_speech_div_name);
            new_nominee.appendChild(nominee_speeches);

            addBlankSpeech(nominee_index);
		}

		function addBlankSpeech(nominee_index){
            const speech_parent_div_name = 'nominee_' + nominee_index + '_speeches';
            let speech_index;
            if (document.getElementById(speech_parent_div_name).lastChild === null) {
                speech_index = document.getElementById(speech_parent_div_name).childElementCount
            } else {
                speech_index = parseInt(document.getElementById(speech_parent_div_name).lastChild.id.replace('nominee_' + nominee_index + '_speech_', '')) + 1
            }
            const speech_div_name = 'nominee_' + nominee_index + '_speech_' + speech_index;

            const new_nominee_speech = document.createElement('div');
            new_nominee_speech.setAttribute('id',speech_div_name);
		    new_nominee_speech.innerHTML += "<p>Positions:</p>";
		    let nominee_position;
            {%  for position in positions %}
                nominee_position = document.createElement('div');
                nominee_position.setAttribute('style','display:inline-block');
                nominee_position.innerHTML += "<input name=\"[{{nominee_key}}]["+nominee_index+"][{{speech_and_position_pairing_key}}]["+speech_index+"][{{position_names_key}}]\"  " +
                    "type=\"checkbox\" id=\"{{ position.position_name }}\" value=\"{{ position.position_name }}\" />";
                    nominee_position.innerHTML += "<label>{{ position.position_name }}</label><br>";
                    new_nominee_speech.appendChild(nominee_position);
            {%  endfor %}

            new_nominee_speech.innerHTML += "<p>Speech: (speech needs to already be in HTML format)<br>" +
                "<textarea name=\"[{{nominee_key}}]["+nominee_index+"][{{speech_and_position_pairing_key}}]["+speech_index+"][{{speech_key}}]\" " +
                "cols=\"40\" rows=\"1\" required>NONE</textarea></p>"
            new_nominee_speech.innerHTML += "<input type=\"button\" value=\"Remove Speech\" onClick=\"removeDiv('#"+speech_div_name+"');\">";
            document.getElementById(speech_parent_div_name).appendChild(new_nominee_speech);
		}
    </script>
{% endblock %}
